name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ main ]  # 触发条件，推送到main分支时运行

jobs:
  deploy:
    runs-on: ubuntu-latest  # 用Ubuntu环境

    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # 拉取代码

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # 用Node 20，Wrangler跑得稳

    - name: Install Wrangler
      run: npm install -g @cloudflare/wrangler  # 全局装Wrangler

    - name: Replace KV_NAME in wrangler.toml
      run: sed -i "s/KV_NAME/${{ secrets.KV_NAME }}/g" wrangler.toml  # 替换KV_NAME

    - name: Deploy to Cloudflare
      run: wrangler deploy --api-token ${{ secrets.CF_API_TOKEN }} --account-id ${{ secrets.CF_ACCOUNT_ID }}
      env:
        CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}  # API Token
        CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}  # Account ID
